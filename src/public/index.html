<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Robotics-Deadlines</title>
    <link rel="stylesheet" href="style.css">
    <!-- 预加载字体 -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=VT323&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="quest-board pixel-border">
            <div class="board-nails nail-1"></div>
            <div class="board-nails nail-2"></div>
            <div class="board-nails nail-3"></div>
            <div class="board-nails nail-4"></div>
            
            <div class="board-header">
                <h1>※ 机器人投稿任务板 ※</h1>
                <div class="header-subtitle">Robotics Deadlines (Full paper submission)</div>
            </div>
            
            <!-- 添加加载指示器 -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-text">正在加载任务列表...</div>
            </div>
            
            <div id="conferences" class="conferences-list"></div>
            
            <button id="addQuestBtn" class="add-quest-btn">+ 添加会议</button>
            
            <div id="questForm" class="quest-form">
                <div class="form-group">
                    <label for="questTitle">会议名称:</label>
                    <input type="text" id="questTitle" placeholder="输入会议名称">
                </div>
                <div class="form-group">
                    <label for="questDescription">会议描述:</label>
                    <textarea id="questDescription" rows="2" placeholder="输入会议描述"></textarea>
                </div>
                <div class="form-group">
                    <label for="questCategory">会议类别:</label>
                    <select id="questCategory">
                        <option value="strongly-robotics">机器人强相关任务</option>
                        <option value="somewhere-between">交叉领域任务</option>
                        <option value="strongly-ai">AI强相关任务</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="questCCF">CCF等级:</label>
                    <select id="questCCF">
                        <option value="A">CCF A</option>
                        <option value="B">CCF B</option>
                        <option value="C">CCF C</option>
                        <option value="">无分级</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="questDeadline">截稿日期:</label>
                    <input type="date" id="questDeadline">
                </div>
                <div class="form-group">
                    <label for="questTime">截稿时间:</label>
                    <input type="time" id="questTime" value="23:59">
                </div>
                <div class="form-buttons">
                    <button class="save-btn" id="saveQuest">保存任务</button>
                    <button class="cancel-btn" id="cancelQuest">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conferences = [];
        // 存储所有定时器的对象
        let countdownTimers = {};
        // 设备类型标志
        let isDesktop = true;

        // 会议分类定义
        const categories = {
            'strongly-robotics': {
                chinese: '机器人强相关任务',
                english: 'Strongly Related to Robotics'
            },
            'somewhere-between': {
                chinese: '交叉领域任务',
                english: 'Somewhere Between'
            },
            'strongly-ai': {
                chinese: 'AI强相关任务',
                english: 'Strongly Related to AI'
            }
        };
        
        // CCF分级颜色定义
        const ccfColors = {
            'A': '#ffd866', // 金色
            'B': '#78dcca', // 青色
            'C': '#fc9867', // 橙色
            '': '#e8e0c9'   // 默认浅色
        };

        // 获取已存储的会议数据
        function loadConferences() {
            // 显示加载指示器
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'flex';
            
            fetch('/api/conferences')
                .then(response => response.json())
                .then(data => {
                    // 清除之前的所有定时器
                    clearAllCountdowns();
                    conferences = data;
                    
                    // 构建完整的DOM结构
                    const fragment = buildConferencesDom(conferences);
                    
                    // 一次性更新DOM
                    const conferencesDiv = document.getElementById("conferences");
                    conferencesDiv.innerHTML = "";
                    conferencesDiv.appendChild(fragment);
                    
                    // 隐藏加载指示器
                    loadingIndicator.style.display = 'none';
                    
                    // 启动所有倒计时
                    startAllCountdowns();
                })
                .catch(error => {
                    console.error('获取会议数据错误:', error);
                    loadingIndicator.innerHTML = '<div class="error-message">加载失败，请刷新页面重试</div>';
                });
        }
        
        // 构建会议DOM结构（不直接添加到页面）
        function buildConferencesDom(conferencesData) {
            const fragment = document.createDocumentFragment();
            
            // 为每个分类创建一个部分
            Object.entries(categories).forEach(([categoryId, category]) => {
                const categoryDiv = document.createElement("div");
                categoryDiv.classList.add("category-section");
                categoryDiv.innerHTML = `
                    <h2>
                        ${category.chinese}
                        <span class="english-title">${category.english}</span>
                    </h2>
                `;
                
                // 获取该分类下的所有会议
                const categoryConferences = conferencesData.filter(conf => conf.category === categoryId);
                
                if (categoryConferences.length > 0) {
                    const questList = document.createElement("ul");
                    questList.classList.add("quest-list");
                    
                    // 根据设备类型使用不同的布局
                    if (isDesktop) {
                        questList.classList.add("desktop-list");
                    } else {
                        questList.classList.add("mobile-list");
                    }
                    
                    categoryConferences.forEach((conference) => {
                        const questItem = document.createElement("li");
                        questItem.classList.add("quest-item");
                        
                        // 创建CCF标签HTML
                        const ccfTag = conference.ccf 
                            ? `<span class="ccf-tag ccf-${conference.ccf.toLowerCase()}" style="background-color: ${ccfColors[conference.ccf] || ccfColors['']}">CCF ${conference.ccf}</span>` 
                            : '';

                        // 根据设备类型使用不同的模板
                        if (isDesktop) {
                            questItem.innerHTML = `
                                <h3 class="conference-name">
                                    ${conference.name}
                                    ${ccfTag}
                                </h3>
                                <p class="conference-description">${conference.description || '无描述'}</p>
                                <div class="quest-details desktop-details">
                                    <div class="quest-difficulty">
                                        <div class="deadline">截稿日期: ${formatDate(conference.deadline)}</div>
                                    </div>
                                    <div id="countdown-${conference.id}" class="countdown">计算中...</div>
                                </div>
                            `;
                        } else {
                            questItem.innerHTML = `
                                <h3 class="conference-name">
                                    ${conference.name}
                                    ${ccfTag}
                                </h3>
                                <p class="conference-description">${conference.description || '无描述'}</p>
                                <div class="quest-details mobile-details">
                                    <div class="quest-difficulty">
                                        <div class="deadline">截稿日期: ${formatDate(conference.deadline)}</div>
                                    </div>
                                    <div id="countdown-${conference.id}" class="countdown">计算中...</div>
                                </div>
                            `;
                        }
                        questList.appendChild(questItem);
                    });
                    
                    categoryDiv.appendChild(questList);
                } else {
                    categoryDiv.innerHTML += '<p class="no-conferences">暂无任务</p>';
                }
                
                fragment.appendChild(categoryDiv);
            });
            
            return fragment;
        }
        
        // 启动所有倒计时（DOM已完全构建后）
        function startAllCountdowns() {
            conferences.forEach(conference => {
                startCountdown(conference);
            });
        }

        // 清除所有定时器
        function clearAllCountdowns() {
            Object.values(countdownTimers).forEach(timer => {
                clearInterval(timer);
            });
            countdownTimers = {};
        }

        // 格式化日期显示
        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // 如果解析失败，返回原始字符串
            }
            
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 启动倒计时
        function startCountdown(conference) {
            // 使用会议ID创建唯一标识符
            const countdownId = `countdown-${conference.id}`;
            const countdownElement = document.getElementById(countdownId);
            
            if (!countdownElement) {
                console.error(`找不到倒计时元素: ${countdownId}, 会议ID: ${conference.id}, 会议名称: ${conference.name}`);
                return;
            }
            
            // 清除该会议可能存在的旧定时器
            if (countdownTimers[countdownId]) {
                clearInterval(countdownTimers[countdownId]);
            }
            
            // 更新函数
            const updateCountdown = function() {
                try {
                    const now = new Date().getTime();
                    const deadlineDate = new Date(conference.deadline);
                    
                    if (isNaN(deadlineDate.getTime())) {
                        countdownElement.innerHTML = "日期格式错误";
                        console.error(`日期解析错误: ${conference.deadline}`);
                        return;
                    }
                    
                    const distance = deadlineDate.getTime() - now + (20 * 60 * 60 * 1000);

                    if (distance < 0) {
                        countdownElement.innerHTML = '<div class="expired-stamp">已过期</div>';
                        const questItem = countdownElement.closest('.quest-item');
                        if (questItem) {
                            questItem.classList.add("expired");
                        }
                        clearInterval(countdownTimers[countdownId]);
                        delete countdownTimers[countdownId];
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownElement.innerHTML = `${days}天 ${hours}时 ${minutes}分 ${seconds}秒`;
                } catch (error) {
                    console.error(`倒计时更新错误: ${error.message}`);
                    countdownElement.innerHTML = "计算错误";
                }
            };
            
            // 立即执行一次
            updateCountdown();
            
            // 设置定时器并保存引用
            countdownTimers[countdownId] = setInterval(updateCountdown, 1000);
        }

        // 添加新会议功能
        function setupAddConferenceForm() {
            const addQuestBtn = document.getElementById('addQuestBtn');
            const questForm = document.getElementById('questForm');
            const saveQuestBtn = document.getElementById('saveQuest');
            const cancelQuestBtn = document.getElementById('cancelQuest');
            
            // 显示表单
            addQuestBtn.addEventListener('click', function() {
                questForm.classList.add('active');
                addQuestBtn.style.display = 'none';
            });
            
            // 取消添加
            cancelQuestBtn.addEventListener('click', function() {
                questForm.classList.remove('active');
                addQuestBtn.style.display = 'block';
                clearForm();
            });
            
            // 保存新会议
            saveQuestBtn.addEventListener('click', function() {
                const name = document.getElementById('questTitle').value.trim();
                const description = document.getElementById('questDescription').value.trim();
                const category = document.getElementById('questCategory').value;
                const ccf = document.getElementById('questCCF').value;
                const deadlineDate = document.getElementById('questDeadline').value;
                const deadlineTime = document.getElementById('questTime').value;
                
                if (name && deadlineDate) {
                    // 创建ISO格式日期字符串
                    const deadlineStr = `${deadlineDate}T${deadlineTime}:00`;
                    
                    // 创建新会议对象
                    const newConference = {
                        name,
                        description,
                        category,
                        ccf,
                        deadline: deadlineStr
                    };
                    
                    // 发送到服务器
                    fetch('/api/conferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(newConference)
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 重新加载会议数据
                        loadConferences();
                        questForm.classList.remove('active');
                        addQuestBtn.style.display = 'block';
                        clearForm();
                    })
                    .catch(error => {
                        console.error('添加会议错误:', error);
                        alert('添加会议失败，请重试');
                    });
                } else {
                    alert('请填写必填字段：会议名称和截稿日期');
                }
            });
            
            // 清空表单
            function clearForm() {
                document.getElementById('questTitle').value = '';
                document.getElementById('questDescription').value = '';
                document.getElementById('questCategory').selectedIndex = 0;
                document.getElementById('questCCF').selectedIndex = 0;
                document.getElementById('questDeadline').value = '';
                document.getElementById('questTime').value = '23:59';
            }
            
            // 设置日期选择器的最小日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('questDeadline').min = today;
        }

        // 为所有交互元素添加触摸反馈
        function addTouchFeedback() {
            // 只在移动设备上添加触摸反馈
            if (!isDesktop) {
                document.querySelectorAll('.quest-item, .add-quest-btn, .save-btn, .cancel-btn').forEach(el => {
                    el.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.97)';
                    });
                    el.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                });
            }
        }
        
        // 检测设备类型
        function detectDeviceType() {
            // 更复杂的设备检测逻辑
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // 检测移动设备
            if (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet|ipad/i.test(userAgent)) {
                document.body.classList.add('mobile-device');
                isDesktop = false;
            } else {
                document.body.classList.add('desktop-device');
                isDesktop = true;
            }
            
            // 根据屏幕宽度进一步判断
            if (window.innerWidth <= 768) {
                document.body.classList.add('small-screen');
                isDesktop = false;
            }
            
            console.log(`设备类型: ${isDesktop ? '桌面端' : '移动端'}`);
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 首先检测设备类型
            detectDeviceType();
            
            // 然后加载会议数据
            loadConferences();
            setupAddConferenceForm();
            
            // 只在移动设备上添加触摸反馈
            addTouchFeedback();
            
            // 处理窗口大小变化
            window.addEventListener('resize', function() {
                const wasDesktop = isDesktop;
                
                // 重新检测设备类型
                detectDeviceType();
                
                // 如果设备类型发生变化，重新加载会议列表
                if (wasDesktop !== isDesktop) {
                    loadConferences();
                }
            });
        });
    </script>
</body>
</html>