<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robotics-Deadlines</title>
    <link rel="stylesheet" href="style.css">
    <!-- 预加载字体 -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=VT323&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="quest-board pixel-border">
            <div class="board-nails nail-1"></div>
            <div class="board-nails nail-2"></div>
            <div class="board-nails nail-3"></div>
            <div class="board-nails nail-4"></div>
            
            <div class="board-header">
                <h1>※ 机器人投稿任务板 ※</h1>
                <div class="subtitle">Robotics Deadlines (Full paper submission)</div>
            </div>
            
            <!-- 添加加载指示器 -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-text">正在加载任务列表...</div>
            </div>
            
            <div id="conferences" class="conferences-list"></div>
        </div>
    </div>

    <script>
        let conferences = [];
        // 存储所有定时器的对象
        let countdownTimers = {};

        // 会议分类定义
        const categories = {
            'strongly-robotics': {
                chinese: '机器人强相关任务',
                english: 'Strongly Related to Robotics'
            },
            'somewhere-between': {
                chinese: '交叉领域任务',
                english: 'Somewhere Between'
            },
            'strongly-ai': {
                chinese: 'AI强相关任务',
                english: 'Strongly Related to AI'
            }
        };
        
        // CCF分级颜色定义
        const ccfColors = {
            'A': '#ffd866', // 金色
            'B': '#78dcca', // 青色
            'C': '#fc9867', // 橙色
            '': '#e8e0c9'   // 默认浅色
        };

        // 获取已存储的会议数据
        function loadConferences() {
            // 显示加载指示器
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'flex';
            
            fetch('/api/conferences')
                .then(response => response.json())
                .then(data => {
                    // 清除之前的所有定时器
                    clearAllCountdowns();
                    conferences = data;
                    
                    // 构建完整的DOM结构
                    const fragment = buildConferencesDom(conferences);
                    
                    // 一次性更新DOM
                    const conferencesDiv = document.getElementById("conferences");
                    conferencesDiv.innerHTML = "";
                    conferencesDiv.appendChild(fragment);
                    
                    // 隐藏加载指示器
                    loadingIndicator.style.display = 'none';
                    
                    // 启动所有倒计时
                    startAllCountdowns();
                })
                .catch(error => {
                    console.error('获取会议数据错误:', error);
                    loadingIndicator.innerHTML = '<div class="error-message">加载失败，请刷新页面重试</div>';
                });
        }
        
        // 构建会议DOM结构（不直接添加到页面）
        function buildConferencesDom(conferencesData) {
            const fragment = document.createDocumentFragment();
            
            // 为每个分类创建一个部分
            Object.entries(categories).forEach(([categoryId, category]) => {
                const categoryDiv = document.createElement("div");
                categoryDiv.classList.add("category-section");
                categoryDiv.innerHTML = `
                    <h2>
                        ${category.chinese}
                        <span class="english-title">${category.english}</span>
                    </h2>
                `;
                
                // 获取该分类下的所有会议
                const categoryConferences = conferencesData.filter(conf => conf.category === categoryId);
                
                if (categoryConferences.length > 0) {
                    const questList = document.createElement("ul");
                    questList.classList.add("quest-list");
                    
                    categoryConferences.forEach((conference) => {
                        const questItem = document.createElement("li");
                        questItem.classList.add("quest-item");
                        
                        // 创建CCF标签HTML
                        const ccfTag = conference.ccf 
                            ? `<span class="ccf-tag ccf-${conference.ccf.toLowerCase()}" style="background-color: ${ccfColors[conference.ccf] || ccfColors['']}">CCF ${conference.ccf}</span>` 
                            : '';

                        questItem.innerHTML = `
                            <h3 class="conference-name">
                                ${conference.name}
                                ${ccfTag}
                            </h3>
                            <p>此任务需要在截止日期前完成提交，请合理安排时间。</p>
                            <div class="quest-details">
                                <div class="deadline">${formatDate(conference.deadline)}</div>
                                <div id="countdown-${conference.id}" class="countdown">计算中...</div>
                            </div>
                        `;
                        questList.appendChild(questItem);
                    });
                    
                    categoryDiv.appendChild(questList);
                } else {
                    categoryDiv.innerHTML += '<p class="no-conferences">暂无任务</p>';
                }
                
                fragment.appendChild(categoryDiv);
            });
            
            return fragment;
        }
        
        // 启动所有倒计时（DOM已完全构建后）
        function startAllCountdowns() {
            conferences.forEach(conference => {
                startCountdown(conference);
            });
        }

        // 清除所有定时器
        function clearAllCountdowns() {
            Object.values(countdownTimers).forEach(timer => {
                clearInterval(timer);
            });
            countdownTimers = {};
        }

        // 格式化日期显示
        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // 如果解析失败，返回原始字符串
            }
            
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 启动倒计时
        function startCountdown(conference) {
            // 使用会议ID创建唯一标识符
            const countdownId = `countdown-${conference.id}`;
            const countdownElement = document.getElementById(countdownId);
            
            if (!countdownElement) {
                console.error(`找不到倒计时元素: ${countdownId}, 会议ID: ${conference.id}, 会议名称: ${conference.name}`);
                return;
            }
            
            // 清除该会议可能存在的旧定时器
            if (countdownTimers[countdownId]) {
                clearInterval(countdownTimers[countdownId]);
            }
            
            // 更新函数
            const updateCountdown = function() {
                try {
                    const now = new Date().getTime();
                    const deadlineDate = new Date(conference.deadline);
                    
                    if (isNaN(deadlineDate.getTime())) {
                        countdownElement.innerHTML = "日期格式错误";
                        console.error(`日期解析错误: ${conference.deadline}`);
                        return;
                    }
                    
                    const distance = deadlineDate.getTime() - now + (20 * 60 * 60 * 1000);

                    if (distance < 0) {
                        countdownElement.innerHTML = '<div class="expired-stamp">已过期</div>';
                        countdownElement.classList.add("expired");
                        clearInterval(countdownTimers[countdownId]);
                        delete countdownTimers[countdownId];
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownElement.innerHTML = `${days}天 ${hours}时 ${minutes}分 ${seconds}秒`;
                } catch (error) {
                    console.error(`倒计时更新错误: ${error.message}`);
                    countdownElement.innerHTML = "计算错误";
                }
            };
            
            // 立即执行一次
            updateCountdown();
            
            // 设置定时器并保存引用
            countdownTimers[countdownId] = setInterval(updateCountdown, 1000);
        }

        // 页面加载完成后获取会议数据
        document.addEventListener('DOMContentLoaded', loadConferences);
    </script>
</body>
</html>